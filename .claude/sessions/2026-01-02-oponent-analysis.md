# Oponent Analysis - External Code Review Verification

**Date:** 02.01.2026
**Purpose:** Verify external analysis claims against actual Sentinel codebase

---

## Summary

| Category | Count |
|----------|-------|
| TRUE | 8 |
| PARTIALLY TRUE | 6 |
| FALSE | 4 |

---

## Priority Issues Identified

### P0 - BLOCKER

**JSONPath Extraction Not Implemented**
- **File:** `packages/extractor/src/extraction/extract.ts:76-77`
- **Issue:** Throws "JSONPath not implemented yet"
- **Impact:** JSON API monitoring completely broken
- **Fix:** Implement JSONPath extraction or block creation of JSON rules

### P1 - HIGH

1. **Missing Circuit Breaker for Paid Services**
   - **File:** `apps/api/src/extractor/tiered-fetch.service.ts`
   - **Issue:** No circuit breaker pattern for BrightData/2captcha failures
   - **Impact:** Continuous charges during service outages
   - **Fix:** Add circuit breaker with failure threshold and cooldown

2. **Duplicate Error Codes**
   - **Files:**
     - `packages/shared/src/domain.ts` (legacy: E101, E201, E301)
     - `packages/shared/src/types/error-codes.ts` (new: ExtractorError enum)
   - **Issue:** Two parallel error code systems
   - **Impact:** Inconsistent error handling, debugging confusion
   - **Fix:** Deprecate legacy codes, migrate to enum

3. **Disabled LlmExtractionService**
   - **File:** `apps/api/src/extractor/llm-extraction.service.ts`
   - **Issue:** Service exists but disabled, dead code paths
   - **Impact:** Code maintenance overhead
   - **Fix:** Remove or implement properly

---

## Detailed Verification

### TRUE Claims

1. **TypeScript Monorepo** - Turborepo with apps/api, apps/web, apps/worker, apps/extension, packages/*

2. **NestJS API with Prisma** - apps/api uses @nestjs/*, prisma client

3. **Tiered Fetch Architecture**
   - FREE: HTTP → Headless → FlareSolverr
   - PAID: Bright Data ($0.0015/req) → 2captcha

4. **BullMQ for Job Processing** - apps/worker with BullMQ processors

5. **CSS Selector Generation** - extension generates selectors, filters dynamic classes

6. **Screenshot Capture** - Playwright with element context padding

7. **Multi-Channel Notifications** - OneSignal push, Slack, Discord, webhooks, email

8. **Health Score System** - Rules have healthScore field, updated on success/failure

### PARTIALLY TRUE Claims

1. **"No retry logic"** - PARTIAL
   - HTTP has exponential backoff
   - BrightData missing retry wrapper

2. **"No rate limiting"** - PARTIAL
   - Worker has concurrency limits
   - API missing request rate limiting

3. **"Extension standalone"** - PARTIAL
   - Extension has own manifest/build
   - Uses shared packages

4. **"No validation"** - PARTIAL
   - DTOs have class-validator decorators
   - Some edge cases missing

5. **"Selector unstable"** - PARTIAL
   - CSS_IN_JS_PATTERNS help
   - E-commerce sites need more patterns

6. **"No monitoring"** - PARTIAL
   - Basic logging exists
   - No APM/metrics system

### FALSE Claims

1. **"No JWT validation"** - FALSE
   - `apps/api/src/auth/auth.guard.ts` validates JWTs properly

2. **"Secrets in plaintext"** - FALSE
   - `.env` files with proper gitignore
   - Some encrypted in Prisma (webhookSecret)

3. **"Health score never updates"** - FALSE
   - `rules.service.ts:updateHealthScore()` called on run completion

4. **"No error handling"** - FALSE
   - Try-catch blocks throughout
   - Global exception filter in NestJS

---

## Recommended Action Plan

### Phase 1: P0 Fix (Immediate)
- [ ] Implement JSONPath extraction OR
- [ ] Block JSON rule creation with clear error

### Phase 2: P1 Fixes (This Week)
- [ ] Add circuit breaker to tiered-fetch.service.ts
- [ ] Consolidate error codes to single enum
- [ ] Remove/implement LlmExtractionService

### Phase 3: Improvements (Backlog)
- [ ] Add API rate limiting
- [ ] Add BrightData retry wrapper
- [ ] Expand CSS_IN_JS_PATTERNS for more sites
- [ ] Add APM/metrics (Sentry, DataDog)

---

*Generated by Oponent Agent - 02.01.2026*
